name: Tide Creation CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  integration-test:
    name: End-to-End Tide Creation Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          submodules: recursive
      
      - name: Install Required Tools (act only)
        if: env.ACT
        continue-on-error: true
        run: |
          apt-get update && apt-get install -y lsof netcat-openbsd
      
      - name: Install Flow CLI
        run: sh -ci "$(curl -fsSL https://raw.githubusercontent.com/onflow/flow-cli/master/install.sh)"
      
      - name: Update PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Verify Flow CLI Installation
        run: flow version
      
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly
      
      - name: Make scripts executable
        run: |
          chmod +x ./local/setup_and_run_emulator.sh
          chmod +x ./local/deploy_full_stack.sh
      
      - name: Setup and Run Emulator
        run: |
          ./local/setup_and_run_emulator.sh &
          sleep 60
      
      - name: Deploy Full Stack
        run: |
          DEPLOYMENT_OUTPUT=$(./local/deploy_full_stack.sh)
          echo "$DEPLOYMENT_OUTPUT"
          FLOW_VAULTS_REQUESTS_CONTRACT=$(echo "$DEPLOYMENT_OUTPUT" | grep "FlowVaultsRequests Contract:" | sed 's/.*: //')
          echo "CONTRACT_ADDRESS=$FLOW_VAULTS_REQUESTS_CONTRACT" >> $GITHUB_ENV
      
      - name: Create Tide Request from EVM
        run: |
          forge script ./solidity/script/FlowVaultsTideOperations.s.sol:FlowVaultsTideOperations \
            --sig "runCreateTide(address)" ${{ env.CONTRACT_ADDRESS }} \
            --rpc-url http://localhost:8545 \
            --broadcast \
            --legacy
      
      - name: Process Requests
        run: flow transactions send ./cadence/transactions/process_requests.cdc --signer tidal --gas-limit 9999

      - name: Verify Tide Creation
        run: |
          echo "=== Verifying Tide Creation ==="
          
          # Check tide details using your script
          TIDE_CHECK=$(flow scripts execute ./cadence/scripts/check_tide_details.cdc 0x045a1763c93006ca)
          echo "$TIDE_CHECK"
          
          # Verify that we have at least one EVM address with tides
          if echo "$TIDE_CHECK" | grep -q '"totalEVMAddresses": 1'; then
            echo "✅ EVM address registered"
          else
            echo "❌ No EVM addresses found"
            exit 1
          fi
          
          # Verify that we have at least one tide created
          if echo "$TIDE_CHECK" | grep -q '"totalMappedTides": 1'; then
            echo "✅ Tide created successfully"
          else
            echo "❌ No tides found"
            exit 1
          fi
          
          # Verify the specific EVM address has the tide
          if echo "$TIDE_CHECK" | grep -q '6813eb9362372eef6200f3b1dbc3f819671cba69'; then
            echo "✅ Tide mapped to correct EVM address"
          else
            echo "❌ EVM address mapping not found"
            exit 1
          fi
          
          echo ""
          echo "✅ All verifications passed!"
          echo "✅ E2E Tide Creation Test completed successfully!"