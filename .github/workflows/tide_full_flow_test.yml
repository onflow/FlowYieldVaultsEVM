name: Tide Full Flow CI

# This workflow tests the complete tide lifecycle:
# 1. Create tide with initial deposit (10 FLOW)
# 2. Add additional deposit (20 FLOW) - Total: 30 FLOW  
# 3. Withdraw half (15 FLOW) - Remaining: 15 FLOW
# 4. Close tide (withdraw remaining 15 FLOW and close position)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  integration-test:
    name: End-to-End Tide Full Flow Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          submodules: recursive
      
      - name: Install Flow CLI
        run: sh -ci "$(curl -fsSL https://raw.githubusercontent.com/onflow/flow-cli/master/install.sh)"
      
      - name: Update PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Verify Flow CLI Installation
        run: flow version
      
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly-fa9f934bdac4bcf57e694e852a61997dda90668a
      
      - name: Make scripts executable
        run: |
          chmod +x ./local/setup_and_run_emulator.sh
          chmod +x ./local/deploy_full_stack.sh
      
      # Step 1: Setup environment and run emulator in background
      - name: Setup and Run Emulator
        run: |
          ./local/setup_and_run_emulator.sh &
          sleep 5
      
      # Step 2: Deploy full stack
      - name: Deploy Full Stack
        run: |
          DEPLOYMENT_OUTPUT=$(./local/deploy_full_stack.sh)
          echo "$DEPLOYMENT_OUTPUT"
          FLOW_VAULTS_REQUESTS_CONTRACT=$(echo "$DEPLOYMENT_OUTPUT" | grep "FlowVaultsRequests Contract:" | sed 's/.*: //')
          echo "CONTRACT_ADDRESS=$FLOW_VAULTS_REQUESTS_CONTRACT" >> $GITHUB_ENV
      
      # Step 3: Create tide from EVM (10 FLOW)
      - name: Create Tide Request from EVM
        run: |
          forge script ./solidity/script/FlowVaultsTideOperations.s.sol:FlowVaultsTideOperations \
            --sig "runCreateTide(address)" ${{ env.CONTRACT_ADDRESS }} \
            --rpc-url localhost:8545 \
            --broadcast \
            --legacy
        env:
          AMOUNT: 10000000000000000000
      
      # Step 4: Process create tide request
      - name: Process Create Tide Request
        run: flow transactions send ./cadence/transactions/process_requests.cdc --signer tidal
      
      # Step 5: Check tide details after creation
      - name: Check Tide Details After Creation
        run: flow scripts execute ./cadence/scripts/check_tide_details.cdc 1 0x6813Eb9362372EEF6200f3b1dbC3f819671cBA69
      
      # Step 6: Deposit to the created tide (add 20 FLOW)
      - name: Deposit to Tide from EVM
        run: |
          forge script ./solidity/script/FlowVaultsTideOperations.s.sol:FlowVaultsTideOperations \
            --sig "runDepositToTide(address,uint64)" ${{ env.CONTRACT_ADDRESS }} 1 \
            --rpc-url localhost:8545 \
            --broadcast \
            --legacy
        env:
          AMOUNT: 20000000000000000000
      
      # Step 7: Process deposit request
      - name: Process Deposit Request
        run: flow transactions send ./cadence/transactions/process_requests.cdc --signer tidal
      
      # Step 8: Check tide details after deposit
      - name: Check Tide Details After Deposit
        run: flow scripts execute ./cadence/scripts/check_tide_details.cdc 1 0x6813Eb9362372EEF6200f3b1dbC3f819671cBA69
      
      # Step 9: Withdraw half from tide (withdraw 15 FLOW, leaving 15 FLOW)
      - name: Withdraw Half from Tide
        run: |
          forge script ./solidity/script/FlowVaultsTideOperations.s.sol:FlowVaultsTideOperations \
            --sig "runWithdrawFromTide(address,uint64,uint256)" ${{ env.CONTRACT_ADDRESS }} 1 15000000000000000000 \
            --rpc-url localhost:8545 \
            --broadcast \
            --legacy
      
      # Step 10: Process withdraw request
      - name: Process Withdraw Request
        run: flow transactions send ./cadence/transactions/process_requests.cdc --signer tidal
      
      # Step 11: Check tide details after withdrawal
      - name: Check Tide Details After Withdrawal
        run: flow scripts execute ./cadence/scripts/check_tide_details.cdc 1 0x6813Eb9362372EEF6200f3b1dbC3f819671cBA69
      
      # Step 12: Close tide (withdraws remaining funds and closes position)
      - name: Close Tide
        run: |
          forge script ./solidity/script/FlowVaultsTideOperations.s.sol:FlowVaultsTideOperations \
            --sig "runCloseTide(address,uint64)" ${{ env.CONTRACT_ADDRESS }} 1 \
            --rpc-url localhost:8545 \
            --broadcast \
            --legacy
      
      # Step 13: Process close tide request
      - name: Process Close Tide Request
        run: flow transactions send ./cadence/transactions/process_requests.cdc --signer tidal
      
      # Step 14: Verify tide was closed
      - name: Check Tide Details After Close
        run: flow scripts execute ./cadence/scripts/check_tide_details.cdc 1 0x6813Eb9362372EEF6200f3b1dbC3f819671cBA69
      
      # Cleanup
      - name: Cleanup
        if: always()
        run: |
          # Kill any remaining processes
          lsof -ti :8080 | xargs kill -9 2>/dev/null || true
          lsof -ti :8545 | xargs kill -9 2>/dev/null || true
          lsof -ti :3569 | xargs kill -9 2>/dev/null || true
          lsof -ti :8888 | xargs kill -9 2>/dev/null || true
